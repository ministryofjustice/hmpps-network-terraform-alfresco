[
    {
        "name": "elasticsearch",
        "image": "${image_url}",
        "cpu": 500,
        "memory": 4500,
        "essential": true,
        "environment" : [
            { 
                "name" : "HMPPS_JVM_HEAPSIZE", 
                "value" : "4g" 
            }                    
        ],
        "mountPoints": [
            {
                "sourceVolume": "backup",
                "containerPath": "${efs_mount_path}",
                "readOnly": false
            },
            {
                "sourceVolume": "data",
                "containerPath": "/usr/share/elasticsearch/data",
                "readOnly": false
            },            
            {
                "sourceVolume": "confd",
                "containerPath": "/etc/confd/templates/elasticsearch.yml.tmpl",
                "readOnly": false
            }
        ],
        "portMappings": [
            {
                "hostPort": 9200,
                "containerPort": 9200,
                "protocol": "tcp"
            },
            {
                "hostPort": 9300,
                "containerPort": 9300,
                "protocol": "tcp"
            }
        ],
        "ulimits": [
            {
                "name": "memlock",
                "softLimit": -1,
                "hardLimit": -1
            }
        ],
        "logConfiguration": {
            "logDriver": "awslogs",
            "options": {
                "awslogs-group": "${log_group_name}",
                "awslogs-region": "${log_group_region}"
            }
        }
    },
    {
        "name": "redis",
        "image": "redis:4-alpine",
        "cpu": 500,
        "memory": 2000,
        "essential": true,
        "portMappings": [
            {
                "hostPort": 6379,
                "containerPort": 6379,
                "protocol": "tcp"
            }
        ],
        "logConfiguration": {
            "logDriver": "awslogs",
            "options": {
                "awslogs-group": "${redis_loggroup}",
                "awslogs-region": "${log_group_region}"
            }
        }
    },
    {
        "name": "kibana",
        "image": "${registry_url}/hmpps-kibana:${docker_tag}",
        "cpu": 500,
        "memory": 2000,
        "essential": true,
        "links": [
            "elasticsearch"
        ],
        "dependsOn": [
            {
            "containerName": "elasticsearch",
            "condition": "HEALTHY"
            }
        ],
        "portMappings": [
            {
                "hostPort": 5601,
                "containerPort": 5601,
                "protocol": "tcp"
            }
        ],
        "ulimits": [
            {
                "name": "nofile",
                "softLimit": 65536,
                "hardLimit": 65536
            }
        ],
        "logConfiguration": {
            "logDriver": "awslogs",
            "options": {
                "awslogs-group": "${kibana_loggroup}",
                "awslogs-region": "${log_group_region}"
            }
        }
    },
    {
        "name": "logstash",
        "image": "${registry_url}/hmpps-logstash:${docker_tag}",
        "cpu": 500,
        "memory": 2000,
        "essential": true,
        "links": [
            "redis",
            "elasticsearch"
        ],
        "dependsOn": [
            {
            "containerName": "redis",
            "condition": "HEALTHY"
            }
        ],
        "environment" : [
            { 
                "name" : "LOGSTASH_OUTPUT_ELASTICSEARCH", 
                "value" : "yes" 
            }                    
        ],
        "portMappings": [
            {
                "hostPort": 2514,
                "containerPort": 2514,
                "protocol": "tcp"
            },
            {
                "hostPort": 9600,
                "containerPort": 9600,
                "protocol": "tcp"
            }
        ],
        "logConfiguration": {
            "logDriver": "awslogs",
            "options": {
                "awslogs-group": "${logstash_loggroup}",
                "awslogs-region": "${log_group_region}"
            }
        }
    }
]